class ExecWait extends DefaultTask {
    String location
    String port
    String ready = 'Started NotificationDecisionService'
    String directory = "./"

    @TaskAction
    def spawnProcess() {

        def portOption = port ? "--server.port=${port}" : ''
        def command = "java -jar ${location} ${portOption}"
        ProcessBuilder builder = new ProcessBuilder(command.split(' '))
        builder.redirectErrorStream(true)
        builder.directory(new File(directory))
        Process process = builder.start()

        InputStream stdout = process.getInputStream()
        BufferedReader reader = new BufferedReader(new
                InputStreamReader(stdout))

        def line
        while ((line = reader.readLine()) != null) {
            println line
            if (line.contains(ready)) {
                println "$command is ready"
                break;
            }
        }
    }
}

ext.ExecWait = ExecWait